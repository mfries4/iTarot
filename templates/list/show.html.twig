{% extends 'base.html.twig' %}
{% block title %}Liste {{ list.name }} - iTarot{% endblock %}
{% block body %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3"><i class="bi bi-folder"></i> {{ list.name }}</h1>
  <div>
    <a href="{{ path('app_game_new', {listId: list.id}) }}" class="btn btn-success"><i class="bi bi-plus-circle"></i> Nouvelle partie</a>
    <form method="post" action="{{ path('app_list_delete', {id: list.id}) }}" style="display: inline-block;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette liste et toutes ses parties ?');">
      <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ list.id) }}">
      <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Supprimer la liste</button>
    </form>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header bg-secondary text-white">Cumul des scores</div>
      <div class="card-body">
        <table class="table table-sm">
          <thead><tr><th>Joueur</th><th class="text-end">Score cumulé</th><th style="width:220px">Visualisation</th><th class="text-end">Prises</th><th class="text-end">Alliés</th><th class="text-end">Parties</th></tr></thead>
          <tbody>
          {% for item in cumulative %}
            <tr>
              <td><strong>{{ item.player.name }}</strong></td>
              <td class="text-end">
                {% if item.score > 0 %}<span class="text-success fw-bold">+{{ item.score }}</span>{% elseif item.score < 0 %}<span class="text-danger fw-bold">{{ item.score }}</span>{% else %}0{% endif %}
              </td>
              <td>
                <div class="scorebar-container" title="{{ item.player.name }}: {{ item.score }}">
                  <div class="scorebar-fill {% if item.score >= 0 %}pos{% else %}neg{% endif %}" data-score="{{ item.score }}"></div>
                </div>
              </td>
              <td class="text-end">{{ item.takerCount }}</td>
              <td class="text-end">{{ item.allyCount }}</td>
              <td class="text-end">{{ item.games }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6 mb-3">
    <div class="card h-100">
      <div class="card-header bg-warning text-dark"><i class="bi bi-trophy-fill"></i> Contrats les plus joués</div>
      <div class="card-body" style="height:240px"><canvas id="contractsChart"></canvas></div>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <div class="card h-100">
      <div class="card-header bg-success text-white"><i class="bi bi-percent"></i> Taux de réussite par contrat</div>
      <div class="card-body" style="height:240px"><canvas id="successRateChart"></canvas></div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header bg-primary text-white"><i class="bi bi-people"></i> Statistiques par joueur</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Joueur</th>
                <th class="text-end">Parties</th>
                <th class="text-end">Victoires</th>
                <th class="text-end">Défaites</th>
                <th class="text-end">Prises</th>
                <th class="text-end">Alliés</th>
                <th class="text-end">Score total</th>
                <th class="text-end">Moyenne</th>
                <th class="text-end">Taux de victoire</th>
                <th>Meilleur contrat</th>
              </tr>
            </thead>
            <tbody>
              {% for p in chartData.perPlayer %}
              <tr>
                <td><strong>{{ p.name }}</strong></td>
                <td class="text-end">{{ p.totalGames }}</td>
                <td class="text-end">{{ p.wins }}</td>
                <td class="text-end">{{ p.losses }}</td>
                <td class="text-end">{{ p.timesTaker }}</td>
                <td class="text-end">{{ p.timesAlly }}</td>
                <td class="text-end">{% if p.totalScore > 0 %}<span class="text-success">+{{ p.totalScore }}</span>{% elseif p.totalScore < 0 %}<span class="text-danger">{{ p.totalScore }}</span>{% else %}0{% endif %}</td>
                <td class="text-end">{{ p.avgScore }}</td>
                <td class="text-end">{{ p.winRate }}%</td>
                <td>
                  {% if p.bestContractLabel %}
                    <span class="badge text-bg-info">{{ p.bestContractLabel }}</span>
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </div>

<h2 class="h4 mb-3">Historique des parties</h2>
{% if list.games|length > 0 %}
<div class="table-responsive">
  <table class="table table-striped">
    <thead class="table-dark">
      <tr>
        <th>Date</th><th>Contrat</th><th>Bouts</th><th>Preneur</th><th>Score preneur</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for game in list.games %}
      <tr>
        <td>{{ game.playedAt|date('d/m/Y H:i') }}</td>
        <td>{{ game.contractType|upper }}</td>
        <td>{{ game.oudlers }}</td>
        <td>{% if game.taker %}{{ game.taker.player.name }}{% endif %}</td>
        <td>{% if game.taker %}{% if game.taker.score > 0 %}<span class="text-success">+{{ game.taker.score }}{% else %}<span class="text-danger">{{ game.taker.score }}{% endif %}</span>{% endif %}</td>
        <td>
          <a href="{{ path('app_game_show', {listId: list.id, gameId: game.id}) }}" class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></a>
          <form method="post" action="{{ path('app_game_delete', {listId: list.id, gameId: game.id}) }}" style="display: inline-block;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette partie ?');">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ game.id) }}">
            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">Aucune partie encore dans cette liste.</div>
{% endif %}
{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const listChartData = {{ chartData|json_encode|raw }};
  const contracts = listChartData.contracts;
  // Barres de score (visualisation relative)
  (function(){
    const scores = listChartData.scores || [];
    if (scores.length === 0) return;
    const maxAbs = Math.max(...scores.map(s => Math.abs(s)));
    const bars = document.querySelectorAll('.scorebar-fill');
    bars.forEach(bar => {
      const score = parseFloat(bar.getAttribute('data-score')) || 0;
      const pct = maxAbs > 0 ? Math.round((Math.abs(score) / maxAbs) * 100) : 0;
      bar.style.width = pct + '%';
    });
  })();
  
  // Graphique des contrats les plus joués
  const contractsCtx = document.getElementById('contractsChart');
  if (contractsCtx) {
    const contractLabels = Object.values(contracts).map(c => c.label);
    const contractTotals = Object.values(contracts).map(c => c.total);
    
    new Chart(contractsCtx, {
      type: 'bar',
      data: {
        labels: contractLabels,
        datasets: [{
          label: 'Nombre de parties',
          data: contractTotals,
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }
  
  // Graphique du taux de réussite
  const successRateCtx = document.getElementById('successRateChart');
  if (successRateCtx) {
    const contractLabels = Object.values(contracts).map(c => c.label);
    const successRates = Object.values(contracts).map(c => c.successRate);
    
    new Chart(successRateCtx, {
      type: 'doughnut',
      data: {
        labels: contractLabels,
        datasets: [{
          label: 'Taux de réussite (%)',
          data: successRates,
          backgroundColor: [
            'rgba(75, 192, 192, 0.6)',
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(153, 102, 255, 0.6)'
          ],
          borderColor: [
            'rgba(75, 192, 192, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const contractKey = Object.keys(contracts)[context.dataIndex];
                const total = contracts[contractKey].total;
                const won = contracts[contractKey].won;
                return label + ': ' + value + '% (' + won + '/' + total + ')';
              }
            }
          }
        }
      }
    });
  }
</script>
<style>
  .scorebar-container{position:relative;height:12px;background:var(--surface-2);border-radius:6px;overflow:hidden}
  .scorebar-fill{height:100%;width:0;transition:width .4s ease}
  .scorebar-fill.pos{background:linear-gradient(90deg, #4caf50, #81c784)}
  .scorebar-fill.neg{background:linear-gradient(90deg, #f44336, #e57373)}
</style>
{% endblock %}
